#!/usr/bin/env ruby

require_relative '../lib/mantle'
require_relative '../lib/mantle/sidekiq_overrides'

begin
  require "./initializer"
rescue LoadError
  raise "Implement ./initializer.rb in your application root to boot your application and load dependencies"
end

if ARGV.length < 1 then
  puts "Usage: mantle <command>"
  puts "  Commands: "
  puts "    listen - subscribe to pubsub and enqueue jobs"
  puts "    process - process jobs off the internal queue"
  exit 0
end

Mantle.boot_system!

case ARGV.first.chomp
when "listen"
  trap("SIGINT") { exit! }
  Mantle.run!
when "process"
  Sidekiq.options = { concurrency: 25, require: 'mantle/load_workers', queues: ['update'] }
  cli = Sidekiq::CLI.instance
  cli.parse
  cli.run
end
